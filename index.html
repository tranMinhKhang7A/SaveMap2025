<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Báº£n Ä‘á»“ an toÃ n trong lÅ© ğŸŒ§ï¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { font-family: sans-serif; }
    #map { height: 85vh; width: 100%; margin-top: 10px; }
    .buttons { margin: 10px; }
    button {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      margin-right: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .ngap { background: #e74c3c; color: white; }
    .antoan { background: #27ae60; color: white; }
    .cuuho { background: #f1c40f; color: black; }
    .tacduong { background: #b93d3d; color: white; }
  </style>
</head>

<body>
  <div style="text-align: center; line-height: 1.4;">
    <h3 style="margin: 0; font-size: 20px; color: #0055aa;">
      ğŸŒ§ï¸ Báº¢N Äá»’ AN TOÃ€N TRONG LÅ¨
    </h3>
    <p style="margin: 3px 0 8px 0; font-size: 16px; color: #004080;">
      VÃ¬ má»™t mÃ¹a mÆ°a khÃ´ng ai bá»‹ bá» láº¡i
    </p>
    <p style="font-size: 14px; color: #333;">
      Má»™t báº£n Ä‘á»“ nhá» bÃ©, Ä‘Æ°á»£c váº½ nÃªn bá»Ÿi chÃ­nh nhá»¯ng ngÆ°á»i trong vÃ¹ng lÅ© â€” tháº§y cÃ´, há»c sinh, vÃ  nhá»¯ng táº¥m lÃ²ng nhÃ¢n Ã¡i ğŸ’™
    </p>
  </div>

  <div style="text-align: right; margin-top: 6px;">
    <p style="font-style: italic; font-size: 13px; color: #555;">
      â€“ Tráº§n Minh Khang, lá»›p 8C, THCS PhÃº Minh
    </p>
  </div>

  <!-- Bá»™ lá»c hiá»ƒn thá»‹ Ä‘iá»ƒm -->
  <div style="margin: 10px; font-size: 15px;">
    <label><input type="checkbox" id="filter_ngap" checked> ğŸš« Hiá»‡n Ä‘Æ°á»ng ngáº­p</label>
    <label style="margin-left: 10px;"><input type="checkbox" id="filter_antoan" checked> âœ… Hiá»‡n Ä‘iá»ƒm an toÃ n</label>
    <label style="margin-left: 10px;"><input type="checkbox" id="filter_cuuho" checked> ğŸ†˜ Hiá»‡n cá»©u há»™</label>
    <label style="margin-left: 10px;"><input type="checkbox" id="filter_tacduong" checked> ğŸ›‘ğŸš— Hiá»‡n táº¯c Ä‘Æ°á»ng</label>
  </div>

  <div id="status" style="margin:10px; font-weight:bold; color:green;">
    ğŸŸ¢ Loáº¡i hiá»‡n táº¡i: âœ… Äiá»ƒm an toÃ n
  </div>

  <div class="buttons">
    <button class="ngap" onclick="chonLoai('ngap')">ğŸš« ÄÆ°á»ng ngáº­p</button>
    <button class="antoan" onclick="chonLoai('antoan')">âœ… Äiá»ƒm an toÃ n</button>
    <button class="cuuho" onclick="chonLoai('cuuho')">ğŸ†˜ Cáº§n cá»©u há»™</button>
    <button class="tacduong" onclick="chonLoai('tacduong')">ğŸ›‘ğŸš— Táº¯c Ä‘Æ°á»ng</button>
  </div>

  <div id="map"></div>

  <script>
    var map = L.map('map').setView([21.0285, 105.8542], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    map.locate({ setView: true, maxZoom: 16 });

    function onLocationFound(e) {
      L.marker(e.latlng).addTo(map).bindPopup("ğŸ“ Báº¡n Ä‘ang á»Ÿ Ä‘Ã¢y!").openPopup();
    }

    function onLocationError(e) {
      console.warn("âš ï¸ KhÃ´ng thá»ƒ láº¥y vá»‹ trÃ­:", e.message);
    }

    map.on('locationfound', onLocationFound);
    map.on('locationerror', onLocationError);

    var loai = 'antoan';
    var apiURL = "https://billowing-sea-9e3a.agribarniot.workers.dev/https://script.google.com/macros/s/AKfycbzFeesLV0wX1lIDi1iT7SwWp7DhXLwcWstueOiorJvjPZYPt84E5bmKXvrR2OHksdU/exec";

    // ğŸ”¹ Khi táº£i trang, gá»i API Ä‘á»ƒ hiá»ƒn thá»‹ cÃ¡c Ä‘iá»ƒm Ä‘Ã£ lÆ°u
    fetch(apiURL)
      .then(res => res.json())
      .then(data => {
        data.forEach(item => {
          const lat = parseFloat(item.lat);
          const lng = parseFloat(item.lng);
          if (!isNaN(lat) && !isNaN(lng)) {
            taoMarker(lat, lng, item.loai, item.uuid);
          }
        });
      })
      .catch(err => console.error("Lá»—i táº£i dá»¯ liá»‡u:", err));

    function chonLoai(l) {
      loai = l;
      const text = l === 'ngap' ? 'ğŸš« ÄÆ°á»ng ngáº­p' :
                   l === 'antoan' ? 'âœ… Äiá»ƒm an toÃ n' :
                   l === 'cuuho' ? 'ğŸ†˜ Cáº§n cá»©u há»™' :
                   'ğŸ›‘ğŸš— Táº¯c Ä‘Æ°á»ng';
      document.getElementById('status').textContent = 'ğŸŸ¢ Loáº¡i hiá»‡n táº¡i: ' + text;
    }

    const allMarkers = [];
    const markerMap = new Map();

    function taoMarker(lat, lng, loai, uuid = null) {
      if (uuid && markerMap.has(uuid)) {
        const oldMarker = markerMap.get(uuid);
        if (map.hasLayer(oldMarker)) map.removeLayer(oldMarker);
        markerMap.delete(uuid);
      }

      let iconUrl, text;

      if (loai === 'ngap') {
        iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/26d4.svg";
        text = "ğŸš« Ngáº­p";
      } else if (loai === 'antoan') {
        iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/2705.svg";
        text = "âœ… An toÃ n";
      } else if (loai === 'cuuho') {
        iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f198.svg";
        text = "ğŸ†˜ Cá»©u há»™";
      } else if (loai === 'tacduong') {
        iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f6a7.svg"; // ğŸš§
        text = "ğŸ›‘ğŸš— Táº¯c Ä‘Æ°á»ng";
      } else {
        iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/2753.svg";
        text = "â“ KhÃ´ng rÃµ";
      }

      const icon = L.icon({
        iconUrl: iconUrl,
        iconSize: [28, 28],
        iconAnchor: [14, 28],
        popupAnchor: [0, -28]
      });

      const marker = L.marker([lat, lng], { icon }).addTo(map);
      marker.uuid = uuid;

      // ğŸ§¾ Popup
      let popup = `<b>${text}</b><br><i>${lat.toFixed(5)}, ${lng.toFixed(5)}</i>`;

      if (uuid) {
        popup += `
          <br><label>Thay Ä‘á»•i loáº¡i:</label>
          <select id="newType_${uuid}">
            <option value="ngap" ${loai === "ngap" ? "selected" : ""}>ğŸš« Ngáº­p</option>
            <option value="antoan" ${loai === "antoan" ? "selected" : ""}>âœ… An toÃ n</option>
            <option value="cuuho" ${loai === "cuuho" ? "selected" : ""}>ğŸ†˜ Cá»©u há»™</option>
            <option value="tacduong" ${loai === "tacduong" ? "selected" : ""}>ğŸ›‘ğŸš— Táº¯c Ä‘Æ°á»ng</option>
          </select>
          <br>
          <button onclick="capNhatLoai('${uuid}')">ğŸ’¾ Cáº­p nháº­t</button>
          <button onclick="xoaDiem('${uuid}')">ğŸ—‘ï¸ XÃ³a Ä‘iá»ƒm</button>
        `;
      }

      marker.bindPopup(popup);
      allMarkers.push({ marker, loai });
      if (uuid) markerMap.set(uuid, marker);
      return marker;
    }

    map.on('click', function(e) {
      const lat = e.latlng.lat;
      const lng = e.latlng.lng;

      const tempMarker = taoMarker(lat, lng, loai);

      fetch(apiURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "add",
          loai: loai,
          lat: lat,
          lng: lng
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.uuid) {
          map.removeLayer(tempMarker);
          taoMarker(lat, lng, loai, data.uuid);
        }
      })
      .catch(err => console.error("Lá»—i khi gá»­i:", err));
    });

    function xoaDiem(uuid) {
      const adminKey = prompt("ğŸ”‘ Nháº­p khÃ³a admin Ä‘á»ƒ xÃ³a Ä‘iá»ƒm:");
      if (!adminKey) return;

      fetch(apiURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "delete",
          uuid: uuid,
          adminKey: adminKey
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "deleted") {
          alert("âœ… ÄÃ£ xÃ³a Ä‘iá»ƒm!");
          map.eachLayer(function(layer) {
            if (layer.uuid === uuid) {
              layer.setOpacity(0);
              setTimeout(() => map.removeLayer(layer), 400);
            }
          });
        } else {
          alert("âŒ XÃ³a tháº¥t báº¡i: " + data.message);
        }
      })
      .catch(err => alert("Lá»—i khi xÃ³a: " + err));
    }

    function capNhatLoai(uuid) {
      const select = document.getElementById(`newType_${uuid}`);
      const newType = select.value;

      fetch(apiURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "updateType",
          uuid: uuid,
          loai: newType
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          alert("âœ… ÄÃ£ cáº­p nháº­t loáº¡i Ä‘iá»ƒm!");
          map.eachLayer(function(layer) {
            if (layer.uuid === uuid) {
              const latlng = layer.getLatLng();
              map.removeLayer(layer);
              const index = allMarkers.findIndex(m => m.marker.uuid === uuid);
              if (index !== -1) allMarkers.splice(index, 1);
              const newMarker = taoMarker(latlng.lat, latlng.lng, newType, uuid);
              allMarkers.push({ marker: newMarker, loai: newType });
              capNhatBoLoc();
            }
          });
        } else {
          alert("âŒ Lá»—i: " + data.message);
        }
      })
      .catch(err => alert("âš ï¸ Lá»—i khi cáº­p nháº­t: " + err));
    }

    // ğŸ§­ HÃ m cáº­p nháº­t hiá»ƒn thá»‹ theo bá»™ lá»c
    function capNhatBoLoc() {
      const showNgap = document.getElementById("filter_ngap").checked;
      const showAntoan = document.getElementById("filter_antoan").checked;
      const showCuuho = document.getElementById("filter_cuuho").checked;
      const showTacduong = document.getElementById("filter_tacduong").checked;

      allMarkers.forEach(item => {
        const { marker, loai } = item;
        const hien =
          (loai === "ngap" && showNgap) ||
          (loai === "antoan" && showAntoan) ||
          (loai === "cuuho" && showCuuho) ||
          (loai === "tacduong" && showTacduong);

        if (hien) {
          if (!map.hasLayer(marker)) marker.addTo(map);
        } else {
          if (map.hasLayer(marker)) map.removeLayer(marker);
        }
      });
    }

    document.getElementById("filter_ngap").addEventListener("change", capNhatBoLoc);
    document.getElementById("filter_antoan").addEventListener("change", capNhatBoLoc);
    document.getElementById("filter_cuuho").addEventListener("change", capNhatBoLoc);
    document.getElementById("filter_tacduong").addEventListener("change", capNhatBoLoc);
  </script>
</body>
</html>
