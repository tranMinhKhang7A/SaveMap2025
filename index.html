<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Báº£n Ä‘á»“ an toÃ n trong lÅ© ğŸŒ§ï¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ThÆ° viá»‡n Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- ThÃªm Leaflet Routing Machine -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"
  />
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <style>
    body { font-family: sans-serif; }
    #map { height: 85vh; width: 100%; margin-top: 10px; }
    .buttons { margin: 10px; }
    button {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      margin-right: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .ngap { background: #e74c3c; color: white; }
    .antoan { background: #27ae60; color: white; }
    .cuuho { background: #f1c40f; color: black; }
    .tacduong { background: #b93d3d; color: white; }
  </style>
</head>

<body>
  <div style="text-align: center; line-height: 1.4;">
    <h3 style="margin: 0; font-size: 20px; color: #0055aa;">
      ğŸŒ§ï¸ Báº¢N Äá»’ AN TOÃ€N TRONG LÅ¨
    </h3>
    <p style="margin: 3px 0 8px 0; font-size: 16px; color: #004080;">
      VÃ¬ má»™t mÃ¹a mÆ°a khÃ´ng ai bá»‹ bá» láº¡i
    </p>
    <p style="font-size: 14px; color: #333;">
      Má»™t báº£n Ä‘á»“ nhá» bÃ©, Ä‘Æ°á»£c váº½ nÃªn bá»Ÿi chÃ­nh nhá»¯ng ngÆ°á»i trong vÃ¹ng lÅ© â€” tháº§y cÃ´, há»c sinh, vÃ  nhá»¯ng táº¥m lÃ²ng nhÃ¢n Ã¡i ğŸ’™
    </p>
  </div>


  <!-- Bá»™ lá»c hiá»ƒn thá»‹ Ä‘iá»ƒm -->
  <div style="margin: 10px; font-size: 15px;">
    <label><input type="checkbox" id="filter_ngap" checked> ğŸš« Hiá»‡n Ä‘Æ°á»ng ngáº­p</label>
    <label style="margin-left: 10px;"><input type="checkbox" id="filter_antoan" checked> âœ… Hiá»‡n Ä‘iá»ƒm an toÃ n</label>
    <label style="margin-left: 10px;"><input type="checkbox" id="filter_cuuho" checked> ğŸ†˜ Hiá»‡n cá»©u há»™</label>
    <label style="margin-left: 10px;"><input type="checkbox" id="filter_tacduong" checked> ğŸ›‘ğŸš— Hiá»‡n táº¯c Ä‘Æ°á»ng</label>
  </div>

  <div id="status" style="margin:10px; font-weight:bold; color:green;">
    ğŸŸ¢ Loáº¡i hiá»‡n táº¡i: âœ… Äiá»ƒm an toÃ n
  </div>

  <div class="buttons">
    <button class="ngap" onclick="chonLoai('ngap')">ğŸš« ÄÆ°á»ng ngáº­p</button>
    <button class="antoan" onclick="chonLoai('antoan')">âœ… Äiá»ƒm an toÃ n</button>
    <button class="cuuho" onclick="chonLoai('cuuho')">ğŸ†˜ Cáº§n cá»©u há»™</button>
    <button class="tacduong" onclick="chonLoai('tacduong')">ğŸ›‘ğŸš— Táº¯c Ä‘Æ°á»ng</button>
  </div>
<!--  
<div style="margin:10px;">
  <button onclick="testNhieuNguoi()" style="background:#007bff;color:white;">
    ğŸ§ª Kiá»ƒm thá»­ hiá»‡u nÄƒng nhiá»u ngÆ°á»i dÃ¹ng
  </button>
 </div>
-->
  <div id="map"></div>

  <script>
    // ================== KHá»I Táº O Báº¢N Äá»’ ==================
    var map = L.map('map').setView([21.0285, 105.8542], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    map.locate({ setView: true, maxZoom: 16 });

    let userLocation = null;
    map.on('locationfound', function(e) {
      userLocation = e.latlng;
      L.marker(e.latlng).addTo(map).bindPopup("ğŸ“ Báº¡n Ä‘ang á»Ÿ Ä‘Ã¢y!").openPopup();
    });

    map.on('locationerror', function(e) {
      console.warn("âš ï¸ KhÃ´ng thá»ƒ láº¥y vá»‹ trÃ­:", e.message);
    });

    // ================== Dá»® LIá»†U & API ==================
    var loai = 'antoan';
    var apiURL = "https://billowing-sea-9e3a.agribarniot.workers.dev/https://script.google.com/macros/s/AKfycbzFeesLV0wX1lIDi1iT7SwWp7DhXLwcWstueOiorJvjPZYPt84E5bmKXvrR2OHksdU/exec";

    const allMarkers = [];
    const markerMap = new Map();

    fetch(apiURL)
      .then(res => res.json())
      .then(data => {
        data.forEach(item => {
          const lat = parseFloat(item.lat);
          const lng = parseFloat(item.lng);
          if (!isNaN(lat) && !isNaN(lng)) {
            taoMarker(lat, lng, item.loai, item.uuid);
          }
        });
      })
      .catch(err => console.error("Lá»—i táº£i dá»¯ liá»‡u:", err));

    // ================== HÃ€M Táº O MARKER ==================
    function taoMarker(lat, lng, loai, uuid = null) {
      if (uuid && markerMap.has(uuid)) {
        const oldMarker = markerMap.get(uuid);
        if (map.hasLayer(oldMarker)) map.removeLayer(oldMarker);
        markerMap.delete(uuid);
      }

      let iconUrl, text;
      if (loai === 'ngap') {
        iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/26d4.svg";
        text = "ğŸš« Ngáº­p";
      } else if (loai === 'antoan') {
        iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/2705.svg";
        text = "âœ… An toÃ n";
      } else if (loai === 'cuuho') {
        iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f198.svg";
        text = "ğŸ†˜ Cá»©u há»™";
      } else if (loai === 'tacduong') {
        iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f6a7.svg";
        text = "ğŸ›‘ğŸš— Táº¯c Ä‘Æ°á»ng";
      } else {
        iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/2753.svg";
        text = "â“ KhÃ´ng rÃµ";
      }

      const icon = L.icon({
        iconUrl: iconUrl,
        iconSize: [28, 28],
        iconAnchor: [14, 28],
        popupAnchor: [0, -28]
      });

      const marker = L.marker([lat, lng], { icon }).addTo(map);
      marker.uuid = uuid;

      let popup = `<b>${text}</b><br><i>${lat.toFixed(5)}, ${lng.toFixed(5)}</i>`;
      if (uuid) {
        popup += `
          <br><label>Thay Ä‘á»•i loáº¡i:</label>
          <select id="newType_${uuid}">
            <option value="ngap" ${loai === "ngap" ? "selected" : ""}>ğŸš« Ngáº­p</option>
            <option value="antoan" ${loai === "antoan" ? "selected" : ""}>âœ… An toÃ n</option>
            <option value="cuuho" ${loai === "cuuho" ? "selected" : ""}>ğŸ†˜ Cá»©u há»™</option>
            <option value="tacduong" ${loai === "tacduong" ? "selected" : ""}>ğŸ›‘ğŸš— Táº¯c Ä‘Æ°á»ng</option>
          </select><br>
          <button onclick="capNhatLoai('${uuid}')">ğŸ’¾ Cáº­p nháº­t</button>
          <button onclick="xoaDiem('${uuid}')">ğŸ—‘ï¸ XÃ³a Ä‘iá»ƒm</button>`;
      }

      marker.bindPopup(popup);
      allMarkers.push({ marker, loai });
      if (uuid) markerMap.set(uuid, marker);
      return marker;
    }

    // ================== Táº O, XÃ“A, Cáº¬P NHáº¬T ==================
    map.on('click', function(e) {
      // Shift + click -> tÃ¬m Ä‘Æ°á»ng
      if (e.originalEvent.shiftKey) {
        const lat = e.latlng.lat, lng = e.latlng.lng;
        L.marker([lat, lng]).addTo(map).bindPopup("ğŸ¯ Äiá»ƒm Ä‘áº¿n").openPopup();
        timDuongAnToan(lat, lng);
        return;
      }

      // Click bÃ¬nh thÆ°á»ng -> thÃªm Ä‘iá»ƒm
      const lat = e.latlng.lat, lng = e.latlng.lng;
      const tempMarker = taoMarker(lat, lng, loai);

      fetch(apiURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "add", loai, lat, lng })
      })
      .then(res => res.json())
      .then(data => {
        if (data.uuid) {
          map.removeLayer(tempMarker);
          taoMarker(lat, lng, loai, data.uuid);
        }
      })
      .catch(err => console.error("Lá»—i khi gá»­i:", err));
    });

    function chonLoai(l) {
      loai = l;
      const text = l === 'ngap' ? 'ğŸš« ÄÆ°á»ng ngáº­p' :
                   l === 'antoan' ? 'âœ… Äiá»ƒm an toÃ n' :
                   l === 'cuuho' ? 'ğŸ†˜ Cáº§n cá»©u há»™' :
                   'ğŸ›‘ğŸš— Táº¯c Ä‘Æ°á»ng';
      document.getElementById('status').textContent = 'ğŸŸ¢ Loáº¡i hiá»‡n táº¡i: ' + text;
    }

    // XÃ³a & cáº­p nháº­t loáº¡i Ä‘iá»ƒm
    function xoaDiem(uuid) {
      const adminKey = prompt("ğŸ”‘ Nháº­p khÃ³a admin Ä‘á»ƒ xÃ³a Ä‘iá»ƒm:");
      if (!adminKey) return;
      fetch(apiURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "delete", uuid, adminKey })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "deleted") {
          alert("âœ… ÄÃ£ xÃ³a Ä‘iá»ƒm!");
          map.eachLayer(layer => {
            if (layer.uuid === uuid) {
              layer.setOpacity(0);
              setTimeout(() => map.removeLayer(layer), 400);
            }
          });
        } else alert("âŒ XÃ³a tháº¥t báº¡i: " + data.message);
      });
    }

    function capNhatLoai(uuid) {
	  const select = document.getElementById(`newType_${uuid}`);
	  const newType = select.value;

	  fetch(apiURL, {
		method: "POST",
		headers: { "Content-Type": "application/json" },
		body: JSON.stringify({ action: "updateType", uuid, loai: newType })
	  })
	  .then(res => res.json())
	  .then(data => {
		if (data.status === "ok") {
		  alert("âœ… ÄÃ£ cáº­p nháº­t loáº¡i Ä‘iá»ƒm!");
		  map.eachLayer(function(layer) {
			if (layer.uuid === uuid) {
			  const latlng = layer.getLatLng();
			  map.removeLayer(layer);

			  // ğŸ”¹ Táº¡o marker má»›i vá»›i icon tÆ°Æ¡ng á»©ng loáº¡i má»›i
			  const newMarker = taoMarker(latlng.lat, latlng.lng, newType, uuid);

			  // ğŸ”¹ Cáº­p nháº­t láº¡i trong allMarkers
			  const index = allMarkers.findIndex(m => m.marker.uuid === uuid);
			  if (index !== -1) {
				allMarkers[index] = { marker: newMarker, loai: newType };
			  }

			  // ğŸ”¹ Cáº­p nháº­t láº¡i bá»™ lá»c hiá»ƒn thá»‹
			  capNhatBoLoc();
			}
		  });
		} else {
		  alert("âŒ Cáº­p nháº­t tháº¥t báº¡i: " + data.message);
		}
	  })
	  .catch(err => console.error("âŒ Lá»—i khi cáº­p nháº­t loáº¡i:", err));
	}


    // ================== Bá»˜ Lá»ŒC HIá»‚N THá»Š ==================
    function capNhatBoLoc() {
      const showNgap = document.getElementById("filter_ngap").checked;
      const showAntoan = document.getElementById("filter_antoan").checked;
      const showCuuho = document.getElementById("filter_cuuho").checked;
      const showTacduong = document.getElementById("filter_tacduong").checked;

      allMarkers.forEach(item => {
        const hien =
          (item.loai === "ngap" && showNgap) ||
          (item.loai === "antoan" && showAntoan) ||
          (item.loai === "cuuho" && showCuuho) ||
          (item.loai === "tacduong" && showTacduong);

        if (hien && !map.hasLayer(item.marker)) map.addLayer(item.marker);
        else if (!hien && map.hasLayer(item.marker)) map.removeLayer(item.marker);
      });
    }

    ["filter_ngap","filter_antoan","filter_cuuho","filter_tacduong"]
      .forEach(id => document.getElementById(id).addEventListener("change", capNhatBoLoc));

    // ================== ğŸš— TÃŒM ÄÆ¯á»œNG AN TOÃ€N ==================
    let currentRoute = null;

    function timDuongAnToan(latB, lngB) {
  if (!userLocation) {
    alert("âš ï¸ ChÆ°a xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c vá»‹ trÃ­ cá»§a báº¡n!");
    return;
  }

  const start = L.latLng(userLocation.lat, userLocation.lng);
  const end = L.latLng(latB, lngB);

  const blocked = allMarkers
    .filter(m => m.loai === "ngap" || m.loai === "tacduong")
    .map(m => m.marker.getLatLng());

  if (currentRoute) {
    map.removeControl(currentRoute);
    currentRoute = null;
  }

  currentRoute = L.Routing.control({
    waypoints: [start, end],
    routeWhileDragging: false,
    lineOptions: { styles: [{ color: "#007bff", weight: 6, opacity: 0.8 }] },
    createMarker: () => null,
    router: L.Routing.osrmv1({
      serviceUrl: "https://router.project-osrm.org/route/v1",
      profile: "driving"
    })
  })
  .on('routesfound', function(e) {
    const route = e.routes[0];
    const distance = (route.summary.totalDistance / 1000).toFixed(2);
    const time = Math.round(route.summary.totalTime / 60);
    const coords = route.coordinates.map(c => [c.lat, c.lng]);

    const intersects = blocked.some(b =>
      route.coordinates.some(c => map.distance(c, b) < 100)
    );

    if (intersects) alert("âš ï¸ Tuyáº¿n Ä‘Æ°á»ng nÃ y cÃ³ thá»ƒ Ä‘i qua khu vá»±c ngáº­p hoáº·c táº¯c Ä‘Æ°á»ng!");

    // Hiá»ƒn thá»‹ popup thÃ´ng tin
    L.popup()
      .setLatLng(end)
      .setContent(`ğŸ›£ï¸ QuÃ£ng Ä‘Æ°á»ng an toÃ n: ${distance} km<br>â±ï¸ Thá»i gian: ~${time} phÃºt`)
      .openOn(map);

    // ğŸŸ¢ Gá»­i dá»¯ liá»‡u tuyáº¿n Ä‘Æ°á»ng lÃªn Google Apps Script
    fetch(apiURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "saveRoute",
        start: { lat: start.lat, lng: start.lng },
        end: { lat: end.lat, lng: end.lng },
        distance,
        time,
        path: coords
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        console.log("âœ… ÄÃ£ lÆ°u tuyáº¿n Ä‘Æ°á»ng vÃ o Google Sheet!");
      } else {
        console.warn("âš ï¸ LÆ°u tuyáº¿n Ä‘Æ°á»ng tháº¥t báº¡i:", data.message);
      }
    })
    .catch(err => console.error("âŒ Lá»—i khi gá»­i tuyáº¿n Ä‘Æ°á»ng:", err));
  })
  .addTo(map);
}
// ================== ğŸ§ª KIá»‚M THá»¬ HIá»†U NÄ‚NG NHIá»€U NGÆ¯á»œI DÃ™NG ==================
async function do1Request() {
  const lat = 21.0285 + Math.random() * 0.01;
  const lng = 105.8542 + Math.random() * 0.01;
  const body = JSON.stringify({ action: "add", loai: "antoan", lat, lng });
  const t1 = performance.now();
  try {
    const res = await fetch(apiURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body
    });
    const t2 = performance.now();
    const phanHoi = (t2 - t1);
    const ok = res.ok;
    await res.json();
    // Giáº£ láº­p Ä‘á»™ trá»… cáº­p nháº­t báº£n Ä‘á»“ 1.0â€“1.5s
    const doTre = 1000 + Math.random() * 500;
    await new Promise(r => setTimeout(r, doTre));
    return { ok, phanHoi, doTre };
  } catch {
    return { ok: false, phanHoi: 0, doTre: 0 };
  }
}

async function testNhieuNguoi() {
  const nguoiDung = [1, 5, 10, 20, 50, 70];
  const ketQua = [];

  for (const soNguoi of nguoiDung) {
    const batDau = performance.now();
    const promises = Array.from({ length: soNguoi }, () => do1Request());
    const results = await Promise.all(promises);
    const ketThuc = performance.now();

    const thanhCong = results.filter(r => r.ok).length;
    const phanHoiTB = (results.reduce((a, b) => a + b.phanHoi, 0) / results.length / 1000).toFixed(2);
    const doTreTB = (results.reduce((a, b) => a + b.doTre, 0) / results.length / 1000).toFixed(2);
    const tiLe = ((thanhCong / results.length) * 100).toFixed(1);
    const tongThoiGian = ((ketThuc - batDau) / 1000).toFixed(2);

    ketQua.push({
      "Sá»‘ ngÆ°á»i dÃ¹ng": soNguoi,
      "Thá»i gian pháº£n há»“i (s)": phanHoiTB,
      "Äá»™ trá»… cáº­p nháº­t (s)": doTreTB,
      "Tá»‰ lá»‡ thÃ nh cÃ´ng (%)": tiLe,
      "Tá»•ng thá»i gian mÃ´ phá»ng (s)": tongThoiGian
    });

    console.log(`âœ… HoÃ n táº¥t kiá»ƒm thá»­ vá»›i ${soNguoi} ngÆ°á»i dÃ¹ng`);
  }

  console.table(ketQua);
  alert("ÄÃ£ hoÃ n táº¥t kiá»ƒm thá»­. Má»Ÿ Console (F12 â†’ Console) Ä‘á»ƒ xem báº£ng káº¿t quáº£.");
}

// ================== THÃŠM THÃ”NG TIN THá»œI TIáº¾T Táº I ÄIá»‚M NGÆ¯á»œI DÃ™NG ==================
const weatherAPI = "https://api.open-meteo.com/v1/forecast";

function hienThiThoiTiet(lat, lng) {
  fetch(`${weatherAPI}?latitude=${lat}&longitude=${lng}&current=temperature_2m,precipitation,weathercode,windspeed_10m`)
    .then(res => res.json())
    .then(data => {
      const w = data.current;
      const html = `
        <b>ğŸŒ¤ï¸ Thá»i tiáº¿t hiá»‡n táº¡i</b><br>
        ğŸŒ¡ï¸ Nhiá»‡t Ä‘á»™: ${w.temperature_2m}Â°C<br>
        ğŸ’§ MÆ°a: ${w.precipitation} mm<br>
        ğŸŒ¬ï¸ GiÃ³: ${w.windspeed_10m} km/h
      `;
      L.control.weather = L.control({ position: 'topright' });
      L.control.weather.onAdd = function() {
        const div = L.DomUtil.create('div', 'weather-info');
        div.style.background = 'rgba(255,255,255,0.9)';
        div.style.padding = '6px';
        div.style.borderRadius = '8px';
        div.style.fontSize = '14px';
        div.innerHTML = html;
        return div;
      };
      L.control.weather.addTo(map);
    })
    .catch(err => console.error("Lá»—i láº¥y thá»i tiáº¿t:", err));
}

map.on('locationfound', function(e) {
  userLocation = e.latlng;
  L.marker(e.latlng).addTo(map).bindPopup("ğŸ“ Báº¡n Ä‘ang á»Ÿ Ä‘Ã¢y!").openPopup();
  hienThiThoiTiet(e.latlng.lat, e.latlng.lng); // âœ… thÃªm dÃ²ng nÃ y
});


  </script>
</body>
</html>
