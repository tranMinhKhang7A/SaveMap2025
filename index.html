<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Báº£n Ä‘á»“ an toÃ n trong lÅ© ğŸŒ§ï¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { font-family: sans-serif; }
    #map { height: 85vh; width: 100%; margin-top: 10px; }
    .buttons { margin: 10px; }
    button {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      margin-right: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .ngap { background: #e74c3c; color: white; }
    .antoan { background: #27ae60; color: white; }
    .cuuho { background: #f1c40f; color: black; }
  </style>
  
</head>

<body>
  <h3>Báº£n Ä‘á»“ an toÃ n trong lÅ© ğŸŒ§ï¸</h3>
  
  <div id="status" style="margin:10px; font-weight:bold; color:green;">
  ğŸŸ¢ Loáº¡i hiá»‡n táº¡i: âœ… Äiá»ƒm an toÃ n
  </div>
  
  <div class="buttons">
    <button class="ngap" onclick="chonLoai('ngap')">ğŸš« ÄÆ°á»ng ngáº­p</button>
    <button class="antoan" onclick="chonLoai('antoan')">âœ… Äiá»ƒm an toÃ n</button>
    <button class="cuuho" onclick="chonLoai('cuuho')">ğŸ†˜ Cáº§n cá»©u há»™</button>
  </div>
  
  <div id="map"></div>

  <script>
    var map = L.map('map').setView([21.0285, 105.8542], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);
    // ğŸ”¹ Äá»‹nh vá»‹ vá»‹ trÃ­ hiá»‡n táº¡i cá»§a ngÆ°á»i dÃ¹ng
	map.locate({ setView: true, maxZoom: 16 });

	function onLocationFound(e) {
	  L.marker(e.latlng).addTo(map).bindPopup("ğŸ“ Báº¡n Ä‘ang á»Ÿ Ä‘Ã¢y!").openPopup();
	}

	function onLocationError(e) {
	  console.warn("âš ï¸ KhÃ´ng thá»ƒ láº¥y vá»‹ trÃ­:", e.message);
	}

	map.on('locationfound', onLocationFound);
	map.on('locationerror', onLocationError);

    var loai = 'antoan';
      var apiURL = "https://billowing-sea-9e3a.agribarniot.workers.dev/https://script.google.com/macros/s/AKfycbzFeesLV0wX1lIDi1iT7SwWp7DhXLwcWstueOiorJvjPZYPt84E5bmKXvrR2OHksdU/exec"; // ğŸ‘ˆ DÃ¡n link API Google Script á»Ÿ Ä‘Ã¢y
    // ğŸ”¹ Khi táº£i trang, gá»i API Ä‘á»ƒ hiá»ƒn thá»‹ cÃ¡c Ä‘iá»ƒm Ä‘Ã£ lÆ°u
   fetch(apiURL)
	  .then(res => res.json())
	  .then(data => {
		console.log("Dá»¯ liá»‡u cÅ© tá»« Sheets:", data);
		data.forEach(item => {
		  taoMarker(item.lat, item.lng, item.loai, item.uuid);
		});
	  })

      .catch(err => console.error("Lá»—i táº£i dá»¯ liá»‡u:", err));

    function chonLoai(l) {
	  loai = l;
	  const text = l === 'ngap' ? 'ğŸš« ÄÆ°á»ng ngáº­p' :
				   l === 'antoan' ? 'âœ… Äiá»ƒm an toÃ n' : 'ğŸ†˜ Cáº§n cá»©u há»™';
	  document.getElementById('status').textContent = 'ğŸŸ¢ Loáº¡i hiá»‡n táº¡i: ' + text;
	}

    function taoMarker(lat, lng, loai, uuid = null) {
	  // ğŸ¨ 1. XÃ¡c Ä‘á»‹nh mÃ u vÃ  nhÃ£n dá»±a trÃªn loáº¡i Ä‘iá»ƒm
	  let color, text;
	  if (loai === 'ngap') {
		color = 'red'; text = 'ğŸš« Ngáº­p';
	  } else if (loai === 'antoan') {
		color = 'green'; text = 'âœ… An toÃ n';
	  } else if (loai === 'cuuho') {
		color = 'orange'; text = 'ğŸ†˜ Cá»©u há»™';
	  } else {
		color = 'gray'; text = 'â“KhÃ´ng rÃµ';
	  }

	  // ğŸ—ºï¸ 2. Táº¡o marker trÃªn báº£n Ä‘á»“
	  const marker = L.circleMarker([lat, lng], {
		radius: 10,
		color: color,
		fillColor: color,
		fillOpacity: 0.8
	  }).addTo(map);

	  marker.uuid = uuid;

	  // ğŸ§© 3. Táº¡o popup hiá»ƒn thá»‹ thÃ´ng tin vÃ  tÃ¹y chá»n
	  let popup = `<b>${text}</b><br><i>${lat.toFixed(5)}, ${lng.toFixed(5)}</i>`;

	  // ğŸ”„ Náº¿u cÃ³ UUID (Ä‘iá»ƒm láº¥y tá»« Google Sheet) â†’ thÃªm chá»©c nÄƒng chá»‰nh sá»­a
	  if (uuid) {
		popup += `
		  <br><label>Thay Ä‘á»•i loáº¡i:</label>
		  <select id="newType_${uuid}">
			<option value="ngap" ${loai === "ngap" ? "selected" : ""}>ğŸš« Ngáº­p</option>
			<option value="antoan" ${loai === "antoan" ? "selected" : ""}>âœ… An toÃ n</option>
			<option value="cuuho" ${loai === "cuuho" ? "selected" : ""}>ğŸ†˜ Cá»©u há»™</option>
		  </select>
		  <br>
		  <button onclick="capNhatLoai('${uuid}')">ğŸ’¾ Cáº­p nháº­t</button>
		  <button onclick="xoaDiem('${uuid}')">ğŸ—‘ï¸ XÃ³a Ä‘iá»ƒm</button>
		`;
	  }

	  marker.bindPopup(popup);
	}

    map.on('click', function(e) {
	  const lat = e.latlng.lat;
	  const lng = e.latlng.lng;
	  taoMarker(lat, lng, loai); // hiá»ƒn thá»‹ táº¡m thá»i khi ngÆ°á»i dÃ¹ng click

	  // Gá»­i dá»¯ liá»‡u lÃªn Google Sheets
	  fetch(apiURL, {
		method: "POST",
		headers: { "Content-Type": "application/json" },
		body: JSON.stringify({
		  action: "add",
		  loai: loai,
		  lat: lat,
		  lng: lng
		})
	  })
	  .then(res => res.json())
	  .then(data => {
		console.log("Pháº£n há»“i:", data);
		if (data.uuid) {
		  // âœ… XÃ³a marker táº¡m vÃ  táº¡o láº¡i vá»›i UUID tháº­t
		  map.eachLayer(function(layer) {
			if (layer instanceof L.CircleMarker && !layer.uuid) {
			  map.removeLayer(layer);
			}
		  });
		  taoMarker(lat, lng, loai, data.uuid);
		}
	  })
	  .catch(err => console.error("Lá»—i khi gá»­i:", err));
	});

	function xoaDiem(uuid) {
	  const adminKey = prompt("ğŸ”‘ Nháº­p khÃ³a admin Ä‘á»ƒ xÃ³a Ä‘iá»ƒm:");
	  if (!adminKey) return;

	  fetch(apiURL, {
		method: "POST",
		headers: { "Content-Type": "application/json" },
		body: JSON.stringify({
		  action: "delete",
		  uuid: uuid,
		  adminKey: adminKey
		})
	  })
	  .then(res => res.json())
	  .then(data => {
		if (data.status === "deleted") {
		  alert("âœ… ÄÃ£ xÃ³a Ä‘iá»ƒm!");
		  location.reload(); // reload láº¡i map
		} else {
		  alert("âŒ XÃ³a tháº¥t báº¡i: " + data.message);
		}
	  })
	  .catch(err => alert("Lá»—i khi xÃ³a: " + err));
	}

	function capNhatLoai(uuid) {
	  const select = document.getElementById(`newType_${uuid}`);
	  const newType = select.value;

	  fetch(apiURL, {
		method: "POST",
		headers: { "Content-Type": "application/json" },
		body: JSON.stringify({
		  action: "updateType",
		  uuid: uuid,
		  loai: newType
		})
	  })
	  .then(res => res.json())
	  .then(data => {
		if (data.status === "ok") {
		  alert("âœ… ÄÃ£ cáº­p nháº­t loáº¡i Ä‘iá»ƒm!");

		  // ğŸ”„ KhÃ´ng reload trang, chá»‰ cáº­p nháº­t marker trÃªn map
		  map.eachLayer(function(layer) {
			if (layer.uuid === uuid) {
			  const latlng = layer.getLatLng(); // âœ… Láº¥y láº¡i lat/lng
			  map.removeLayer(layer);
			  taoMarker(latlng.lat, latlng.lng, newType, uuid);
			}
		  });

		} else {
		  alert("âŒ Lá»—i: " + data.message);
		}
	  })
	  .catch(err => alert("âš ï¸ Lá»—i khi cáº­p nháº­t: " + err));
	}

  </script>
</body>
</html>
